(function(){var o,p,k,l,q,i=Array.prototype.slice,m=function(b,a){return function(){return b.apply(a,arguments)}},s=Object.prototype.hasOwnProperty,j=function(b,a){function d(){this.constructor=b}for(var c in a)s.call(a,c)&&(b[c]=a[c]);d.prototype=a.prototype;b.prototype=new d;b.__super__=a.prototype;return b};Object.extend=function(){var b,a,d,c,e,f,h;a=arguments[0];c=2<=arguments.length?i.call(arguments,1):[];for(f=0,h=c.length;f<h;f++)for(b in d=c[f],d)e=d[b],a[b]=e;return a};Object.slice=function(b,
a){var d,c,e,f;c={};for(e=0,f=a.length;e<f;e++)d=a[e],c[d]=b[d];return c};this.egg={};o=function(b){return b.constructor.ancestors?[b].concat(i.call(b.constructor.ancestors())):[b]};egg.Subscription=function(){function b(a,d,c){this.eventChannel=a;this.callback=d;this.filter=c;this.index=a.length;this.enable()}b.prototype.enable=function(){return this.eventChannel[this.index]=this};b.prototype.cancel=function(){return delete this.eventChannel[this.index]};return b}();egg.Event=function(){function b(a,
d,c){this.name=a;this.params=d;this.sender=c;this.shouldBubble=!0}b.prototype.preventBubbling=function(){return this.shouldBubble=!1};return b}();egg.Publisher=function(){function b(){this.on=m(this.on,this);this.emit=m(this.emit,this);this.silently=m(this.silently,this);this.globalChannel={};this.channels={};this.silent=!1}b.prototype.silently=function(a,d){this.silent=!0;a.call(d);return this.silent=!1};b.prototype.emit=function(a,d,c){var e,f;if(this.silent)return!1;a=new egg.Event(a,d,c);if(c){f=
o(c);for(d=0,e=f.length;d<e;d++){c=f[d];if(!a.shouldBubble)break;this.runChannelCallbacks(this.channels[c.eventsID()],a)}}a.shouldBubble&&this.runChannelCallbacks(this.globalChannel,a);return!0};b.prototype.on=function(a,d,c,e){var f,b,g,e=e?null!=(g=(f=this.channels)[b=e.eventsID()])?g:f[b]={}:this.globalChannel;null==e[a]&&(e[a]=[]);return new egg.Subscription(e[a],d,c)};b.prototype.runChannelCallbacks=function(a,d){if(a)return this.runCallbacks(a[d.name],d),this.runCallbacks(a["*"],d)};b.prototype.runCallbacks=
function(a,d){var c,e,f,b;if(a){b=[];for(e=0,f=a.length;e<f;e++)(c=a[e])&&(!c.filter||c.filter(d))?b.push(c.callback(d.params,d,c)):b.push(void 0);return b}};return b}();egg.publisher=new egg.Publisher;egg.emit=egg.publisher.emit;egg.on=egg.publisher.on;egg.silently=egg.publisher.silently;p=0;k={emit:function(b,a){return egg.publisher.emit(b,a,this)},on:function(){var b,a,d,c;b=1<=arguments.length?i.call(arguments,0):[];if(1===b.length){b=b[0];c=[];for(d in b)a=b[d],c.push(egg.publisher.on(d,a,null,
this));return c}d=b[0];a=b[1];b=b[2];return egg.publisher.on(d,a,b,this)},silently:function(b){return egg.silently(b,this)},eventsID:function(){var b;return"Function"===this.constructor.name&&this.name.length?this.name:null!=(b=this._eventsID)?b:this._eventsID=""+this.constructor.name+"-"+p++}};egg.Events=function(b){b.include(k);return b.extend(k)};egg.Base=function(){function b(a){null==a&&(a={});this.emit("init",{opts:a,instance:this})}b.include=function(a){return Object.extend(this.prototype,
a)};b.extend=function(a){return Object.extend(this,a)};b.use=function(){var a,d;d=arguments[0];a=2<=arguments.length?i.call(arguments,1):[];return d.apply(null,[this].concat(i.call(a)))};b.use(egg.Events);b.sub=function(a,d){if(!a.match(/^[A-Z]\w+$/))throw"invalid class name '"+a+"'";eval("var childClass = function "+a+"(){ "+a+".__super__.constructor.apply(this, arguments) }");j(childClass,this);d&&d.call(childClass,childClass);return childClass};b.parentClass=function(){var a;return null!=(a=this.__super__)?
a.constructor:void 0};b.allClassInstanceVars={};b.classInstanceVars=function(){var a,d,c;return null!=(c=(a=this.allClassInstanceVars)[d=this.name])?c:a[d]={}};b.ancestors=function(){var a,d,c;return null!=(c=(d=this.classInstanceVars()).ancestors)?c:d.ancestors=(a=this.parentClass(),a?[this].concat(a.ancestors()):[this])};b.create=function(a){null==a&&(a={});return new this(a)};b.init=function(a){return this.on("init",function(d){return a.call(d.instance,d.opts)})};b.destroy=function(a){return this.on("destroy",
function(d){return a.call(d.instance,d.opts)})};b.prototype.destroy=function(a){null==a&&(a={});return this.emit("destroy",{opts:a,instance:this})};b.prototype.className=function(){return this.constructor.name};return b}();egg.RestApi=function(b){function a(){a.__super__.constructor.apply(this,arguments)}j(a,b);a.prototype.commonAjaxOpts={dataType:"json"};a.init(function(d){return this.commonAjaxOpts=Object.extend({headers:d.headers},this.commonAjaxOpts)});a.prototype.load=function(d,a){null==a&&
(a={});return this.get(a.url||d.url(),a.params,function(a){var c,b,g,r,n;b=[];n=[];for(g=0,r=a.length;g<r;g++)c=a[g],n.push(b.push(d.create({attrs:c})));return n},"load")};a.prototype.save=function(d,a){null==a&&(a={});return d.isPersisted()?this.update(d,a):this.create(d,a)};a.prototype.sync=function(a,c){var e,f;null==c&&(c={});if(!(e=c.url))if(!(e="function"===typeof a.syncUrl?a.syncUrl():void 0))if(!(e="function"===typeof a.url?a.url():void 0))throw""+a.className()+" needs a syncUrl or url method";
f=e;e=c.params||("function"===typeof a.syncParams?a.syncParams():void 0)||("function"===typeof a.params?a.params():void 0);return this.get(f,e,function(c){return a.set(c)},"sync")};a.prototype.create=function(a,c){var e,f;null==c&&(c={});if(!(e=c.url))if(!(e="function"===typeof a.createUrl?a.createUrl():void 0))if(!(e="function"===typeof a.url?a.url():void 0))throw""+a.className()+" needs a createUrl or url method";f=e;e=c.params||("function"===typeof a.createParams?a.createParams():void 0)||("function"===
typeof a.params?a.params():void 0);return this.post(f,e,function(c){return a.set(c)},"create")};a.prototype.update=function(a,c){var e,f;null==c&&(c={});if(!(e=c.url))if(!(e="function"===typeof a.updateUrl?a.updateUrl():void 0))if(!(e="function"===typeof a.url?a.url():void 0))throw""+a.className()+" needs an updateUrl or url method";f=e;e=c.params||("function"===typeof a.updateParams?a.updateParams():void 0)||("function"===typeof a.params?a.params():void 0);return this.put(f,e,function(c){return a.set(c)},
"update")};a.prototype.destroy=function(a,c){var e,f;null==c&&(c={});if(!(e=c.url))if(!(e="function"===typeof a.destroyUrl?a.destroyUrl():void 0))if(!(e="function"===typeof a.url?a.url():void 0))throw""+a.className()+" needs a destroyUrl or url method";f=e;e=c.params||("function"===typeof a.destroyParams?a.destroyParams():void 0)||("function"===typeof a.params?a.params():void 0);return this["delete"](f,e,null,"destroy")};a.prototype.get=function(a,c,e,f){null==f&&(f="get");return this._ajax(a,{type:"GET",
data:c},e,f)};a.prototype.post=function(a,c,e,f){null==f&&(f="post");return this._ajax(a,{type:"POST",data:c},e,f)};a.prototype.put=function(a,c,e,f){null==f&&(f="put");return this._ajax(a,{type:"PUT",data:c},e,f)};a.prototype["delete"]=function(a,c,e,f){null==f&&(f="delete");return this._ajax(a,{type:"DELETE",data:c},e,f)};a.prototype._ajax=function(a,c,e,f){var b,g=this;null==c&&(c={});null==f&&(f="request");b=$.Deferred();$.ajax(a,Object.extend({},c,this.commonAjaxOpts)).done(function(a){e&&e(a);
b.resolve({data:a});g.emit(""+f+".success",{data:a});return g.emit("request.success",{type:f,data:a})}).fail(function(a,d,c){b.reject({status:d,errors:c});g.emit(""+f+".error",{status:d,errors:c});return g.emit("request.error",{type:f,status:d,errors:c})});return b.promise()};return a}(egg.Base);q=0;egg.model=function(b){b.init(function(a){this._attrs=a.attrs||{};this.id=q++;return b.instances[this.id]=this});b.destroy(function(){return delete b.instances[this.id]});b.extend({instances:{},loadFrom:function(a,
d){var c=this;null==d&&(d={});return a.load(this,d).done(function(e){return c.emit("load",{from:a,instances:e,opts:d})})},where:function(a){return egg.Scope.create({modelClass:this,filter:function(d){var c,e;for(c in a)if(e=a[c],d.get(c)!==e)return!1;return!0}})},find:function(a){var d;return(d=egg.ModelIndex["for"](this,Object.keys(a)))?d.find(a):this.where(a).first()},findOrCreate:function(a){return this.find(a)||this.create({attrs:a})},all:function(){var a,d;return null!=(d=(a=this.classInstanceVars()).all)?
d:a.all=egg.Scope.create({modelClass:this})},destroyAll:function(){return this.all().forEach(function(a){return a.destroy()})},index:function(){var a;a=1<=arguments.length?i.call(arguments,0):[];return egg.ModelIndex.create({modelClass:this,attrNames:a})},count:function(){return this.all().count()},sample:function(a){return this.all().sample(a)},orderBy:function(a){return this.all().orderBy(a)}});return b.include({get:function(a){return this._attrs[a]},attrs:function(){var a;a=1<=arguments.length?
i.call(arguments,0):[];return a.length?Object.slice(this._attrs,a):Object.extend({},this._attrs)},set:function(){var a,d,c,e;a=1<=arguments.length?i.call(arguments,0):[];c=this.attrs();if(1===a.length)for(d in e=a[0],e)a=e[d],this.setOne(d,a);else d=a[0],a=a[1],this.setOne(d,a);d=this.attrs();return this.emit("change",{instance:this,from:c,to:d})},setOne:function(a,d){var c;c=this.get(a);this._attrs[a]=d;return this.emit("change."+a,{instance:this,from:c,to:d})},update:function(){this.set.apply(this,
1<=arguments.length?i.call(arguments,0):[]);return this.save()},save:function(){return this.emit("save",{instance:this})},toJSON:function(){return Object.extend({},this._attrs)}})};egg.activeRecord=function(b,a){var d;null==a&&(a={});var c;if(!(c=a.url))throw"activeRecord plugin needs a url opt";d=a.paramsNamespace;return b.include({isPersisted:function(){return!!this.get("id")},createUrl:function(){return c},url:function(){return""+c+"/"+this.get("id")},params:function(){var a;return d?(a={},a[d]=
this.attrs(),a):this.attrs()}})};egg.Scope=function(b){function a(){a.__super__.constructor.apply(this,arguments)}j(a,b);a.use(egg.Events);a.init(function(a){var c=this;null==a&&(a={});this.sorter=a.sorter;this.filter=a.filter||function(){return!0};this.modelClass=a.modelClass;if(!this.modelClass)throw"Scope needs a modelClass";this.instances={};this._populateInstances();this.subs=[];this.subs.push(this.modelClass.on("init",function(a){if(c.filter(a.instance))return c._add(a.instance)}));this.subs.push(this.modelClass.on("change",
function(a){var d;d=a.instance;if(c.filter(d))return c.has(d)?c.emit("change",a):c._add(d);if(c.has(d))return c._remove(d)}));return this.subs.push(this.modelClass.on("destroy",function(a){if(c.has(a.instance))return c._remove(a.instance)}))});a.destroy(function(){var a,c,e,b,h;b=this.subs;h=[];for(c=0,e=b.length;c<e;c++)a=b[c],h.push(a.cancel());return h});a.prototype._populateInstances=function(){var a,c,e,b;e=this.modelClass.instances;b=[];for(a in e)c=e[a],this.filter(c)?b.push(this.instances[a]=
c):b.push(void 0);return b};a.prototype._add=function(a){this.instances[a.id]=a;return this.emit("add",{instance:a})};a.prototype._remove=function(a){delete this.instances[a.id];return this.emit("remove",{instance:a})};a.prototype.has=function(a){return this.instances[a.id]};a.prototype.forEach=function(a){var c,e,b,h,g;h=this.toArray();g=[];for(e=0,b=h.length;e<b;e++)c=h[e],g.push(a(c));return g};a.prototype.toArray=function(){var a,c,e,b;a=[];b=this.instances;for(c in b)e=b[c],a.push(e);this.sorter&&
a.sort(this.sorter);return a};a.prototype.orderBy=function(a){return this.constructor.create({modelClass:this.modelClass,sorter:function(c,b){return c.get(a)>b.get(a)?1:-1},filter:this.filter})};a.prototype.indexOf=function(a){return this.toArray().indexOf(a)};a.prototype.first=function(){return this.toArray()[0]};a.prototype.last=function(){var a;a=this.toArray();return a[a.length-1]};a.prototype.pluck=function(a){return this.toArray().map(function(c){return c.get(a)})};a.prototype.sample=function(a){var c,
b;c=this.toArray();b=Math.floor(Math.random()*c.length);c=c[b];return a?c.get(a):c};a.prototype.count=function(){return this.toArray().length};a.prototype.toJSON=function(){var a;a=[];this.forEach(function(c){return a.push(c.toJSON())});return a};return a}(egg.Base);l=function(b){return b.sort().join("-")};egg.ModelIndex=function(b){function a(){a.__super__.constructor.apply(this,arguments)}j(a,b);a.indexes={};a["for"]=function(a,c){var b;return null!=(b=this.indexes[a.name])?b[l(c)]:void 0};a.init(function(a){var c,
b=this;this.modelClass=a.modelClass;this.attrNames=a.attrNames.sort();this.models={};if(null==(a=this.constructor.indexes)[c=this.modelClass.name])a[c]={};this.constructor.indexes[this.modelClass.name][l(this.attrNames)]=this;this.modelClass.on("init",function(a){return b.addToIndex(a.instance,a.instance.attrs())});this.modelClass.on("change",function(a){b.removeFromIndex(a.instance,a.from);return b.addToIndex(a.instance,a.to)});return this.modelClass.on("destroy",function(a){return b.removeFromIndex(a.instance,
a.instance.attrs())})});a.prototype.modelKey=function(a){var c,b,f,h,g;b=[];g=this.attrNames;for(f=0,h=g.length;f<h;f++)c=g[f],b.push(a[c]);return b.join("-")};a.prototype.find=function(a){return this.models[this.modelKey(a)]};a.prototype.addToIndex=function(a,c){return this.models[this.modelKey(c)]=a};a.prototype.removeFromIndex=function(a,c){return delete this.models[this.modelKey(c)]};return a}(egg.Base);egg.view=function(b){b.extend({onDOM:function(a,b,c,e){return this.delegatedEvents()[""+b+
"-"+a]={domEvent:b,selector:a,eventName:c,paramsFunc:e}},delegatedEvents:function(){var a;return null!=(a=this._delegatedEvents)?a:this._delegatedEvents={}},onObj:function(a,b){return this.objectSubscriptionSpecs()[a]={eventName:a,callback:b}},objectSubscriptionSpecs:function(){var a;return null!=(a=this._objectSubscriptionSpecs)?a:this._objectSubscriptionSpecs={}}});b.init(function(a){var b;if(a.elem)b=$(a.elem)[0];else throw"Missing elem!";this.elem=b;this.obj=a.obj;this.delegateEvents();this.obj&&
this.subscribeToObj();return this.setClassName()});b.destroy(function(){this.unsetClassName();this.obj&&this.unsubscribeToObj();return this.undelegateEvents()});return b.include({$:function(a){return $(this.elem).find(a)},destroyWithElem:function(){this.destroy();return $(this.elem).remove()},delegateEvents:function(){var a,b,c,e,f=this;this.delegatedEventsEnabled=!0;c=this.constructor.delegatedEvents();e=[];for(b in c)a=c[b],e.push($(this.elem).on(a.domEvent,a.selector,a,function(a){var c;if(f.delegatedEventsEnabled)return c=
{obj:f.obj},a.data.paramsFunc&&Object.extend(c,a.data.paramsFunc.call(f,a)),f.emit(a.data.eventName,c),a.stopPropagation(),a.preventDefault()}));return e},undelegateEvents:function(){return this.delegatedEventsEnabled=!1},subscribeToObj:function(){var a,b,c,e,f;e=this.constructor.objectSubscriptionSpecs();f=[];for(b in e)c=e[b],a=function(){var a,b,d=this;b=c.callback;a="string"===typeof b?function(){var a;a=1<=arguments.length?i.call(arguments,0):[];return d[b].apply(d,a)}:function(){var a;a=1<=
arguments.length?i.call(arguments,0):[];return b.apply(d,a)};return this.objectSubscriptions().push(this.obj.on(c.eventName,a))},f.push(a.call(this));return f},unsubscribeToObj:function(){var a,b,c,e,f;e=this.objectSubscriptions();f=[];for(b=0,c=e.length;b<c;b++)a=e[b],f.push(a.cancel());return f},objectSubscriptions:function(){var a;return null!=(a=this._objectSubscriptions)?a:this._objectSubscriptions=[]},setClassName:function(){if(this.constructor.className)return $(this.elem).addClass(this.constructor.className)},
unsetClassName:function(){if(this.constructor.className)return $(this.elem).removeClass(this.constructor.className)}})};egg.jsModelView=function(b){b.use(egg.view);return b.include({subscribeToObj:function(){var a,b,c,e,f,h,g=this;f=this.constructor.objectSubscriptionSpecs();h=[];for(c in f)e=f[c],b=e.eventName,a=function(){var a;a=1<=arguments.length?i.call(arguments,0):[];return g[e.method].apply(g,a)},this.obj.bind(b,a),h.push(this.objectSubscriptions().push({eventName:b,callback:a}));return h},
unsubscribeToObj:function(){var a,b,c,e,f;e=this.objectSubscriptions();f=[];for(b=0,c=e.length;b<c;b++)a=e[b],f.push(this.obj.unbind(a.eventName,a.callback));return f}})}}).call(this);
